## ---- echo=F---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
knitr::opts_chunk$set(echo = F, prompt = F, warning = F, message = F, comment='#>')
# Thanks to 
# https://github.com/ramnathv/slidify/issues/189#issuecomment-15850008
hook1 <- function(x){ gsub("```\n*```r*\n*", "", x) }
hook2 <- function(x){ gsub("```\n+```\n", "", x) }
knitr::knit_hooks$set(document = hook1)


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
library(tidyverse)
library(magrittr)
library(brms)
library(broom)
library(latex2exp)
library(here)
theme_set(theme_classic())

set.seed(1010)

brm <- function(...) brms::brm(silent = TRUE, refresh = 0, seed = 10101, ...)




## ---- echo=T---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
rats_df <- read_csv(here('data/rats.csv'),
                    col_types = cols(batch = col_character())
)


## ---- echo=T---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
rats_df_42 <- filter(rats_df, batch == '42')

## ---- echo=F---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
af_vec <- rats_df_42 %>% unlist()


## ---- echo=T---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
M <- glm(cbind(m, n-m) ~ 1,
         data = rats_df_42,
         family = binomial(link = 'logit')
)


## ---- echo=T---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
ilogit <- function(x) 1/(1 + exp(-x))
coef(M) %>% ilogit() %>% unname()


## ---- echo=T---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
M <- glm(cbind(m, n-m) ~ 0 + batch,
         data = rats_df,
         family = binomial(link = 'logit')
)


## ---- results='hide'-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
M_estimates <- tidy(M) %>%
  select(term, beta = estimate) %>%
  mutate(term = str_remove(term, 'batch'),
         theta = ilogit(beta)) %>%
  rename(batch = term)

M_estimates %>%
  sample_n(10) %>%
  arrange(beta) %>%
  mutate_at(vars(beta,theta), ~round(., 2))


## ---- echo =T--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
library(lme4)
M_ml <- glmer(cbind(m, n-m) ~ 1 + (1|batch),
              data = rats_df,
              family = binomial(link = 'logit')
)


## ---- echo=T---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
summary(M_ml)


## ---- echo=T---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
ranef(M_ml)$batch %>%
  head()


## ---- echo=T---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
b <- fixef(M_ml)


## ---- echo=T---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
b + ranef(M_ml)$batch %>%
  head()


## ---- echo=T---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
M_ml_estimates <- coef(M_ml)$batch

M_ml_estimates %>%
  head()


## ---- shrinkage, echo=F, fig.cap='Estimates for $\\theta_1, \\theta_2 \\dots \\theta_j \\ldots \\theta_J$ from the flat or non-multilevel model (left) and the multilevel model (right).', fig.align='center', out.width='0.75\\textwidth'----
M_ml_estimates %>%
  rownames_to_column('batch') %>%
  inner_join(M_estimates, by='batch') %>%
  select(batch, multilevel = '(Intercept)', flat = beta) %>%
  gather(type, estimate, -batch) %>%
  mutate(estimate = ilogit(estimate)) %>%
  ggplot(aes(x = type, y = estimate, group = batch)) +
    geom_point() +
    geom_line(size = 0.5, alpha = 0.25) +
    xlab('model type') +
    ylab(TeX('$\\theta$'))


## ---- echo=T---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
alcohol_df <- read_csv(here('data/alcohol.csv'))


## ---- echo=T---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
M_ml <- lmer(alcohol ~ 1 + (1|country),
             data = alcohol_df)

## ---- echo=F---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
phi <-  fixef(M_ml)
tau <- VarCorr(M_ml)  %>% unlist() %>% unname() %>% sqrt()
sigma <- VarCorr(M_ml) %>% attr('sc')
pi_mu <- phi + c(-1, 1) * tau * qnorm(0.975)


## ---- echo=T---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
sleepstudy <- lme4::sleepstudy %>%
  as_tibble()


## ---- sleepstudy, echo=F, fig.align='center', fig.cap="Each figure shows the average reaction time data from a subject in sleep deprivation on each day of the 10 day experiment.", out.width='\\textwidth'----
sleepstudy %>%
  ggplot(aes(x = Days, y = Reaction)) +
  geom_point(size = 0.5) +
  facet_wrap(~Subject) +
  theme_minimal() +
  theme(legend.position = "none")


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
sleepstudy_350 <- sleepstudy %>%
  filter(Subject == 350)


## ---- echo=T---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
M_350 <- lm(Reaction ~ Days, data = sleepstudy_350)


## ---- cho=T----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
coef(M_350)


## ---- echo=T---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
M_flat <- lm(Reaction ~ 0 + Subject + Subject:Days, data = sleepstudy)


## ---- echo=T---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
M_ml <- lmer(Reaction ~ Days + (Days|Subject),
             data = sleepstudy)


## ---- echo=T, results='hide'-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
summary(M_ml)


## ---- echo=T---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
b <- fixef(M_ml)
b


## ---- echo=T---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
VarCorr(M_ml)


## ---- echo=T---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
coef(M_ml)$Subject %>%
  head()


## ---- contour_shrink, echo=F, fig.align='center', fig.cap = 'The contour plot shows the contours of the 2d normal distribution centered at $\\vec{b}$ and whose covariance matrix is $\\Sigma$.', out.width='0.67\\textwidth'----
library(ggrepel)
library(cowplot)
s <- VarCorr(M_ml)$Subject %>% attr('stddev')
s <- diag(s)
P <- VarCorr(M_ml)$Subject %>% attr('correlation')
Sigma <- s %*% P %*% s

contour_df <- map(c(0.25, 0.5, 0.75, 0.9, 0.95),
                  ~ellipse::ellipse(x = Sigma, centre = b, level = .) %>%
                    as_tibble()
) %>% bind_rows(.id = 'level')

M_ml_beta <- M_ml %>%
  coef() %>%
  extract2('Subject') %>%
  rename(intercept = `(Intercept)`, slope = Days) %>%
  rownames_to_column('subject')

M_beta <- M_flat %>%
  coef() %>%
  enframe() %>%
  separate(name, into=c('subject', 'coef'), sep = ':', fill = 'right') %>%
  spread(coef, value) %>%
  mutate(subject = str_remove(subject, 'Subject')) %>%
  select(subject, intercept = `<NA>`, slope=Days)

beta_df2 <- inner_join(M_beta, M_ml_beta, by='subject', suffix = c('_flat', '_multilevel'))

beta_df <- beta_df2 %>%
  pivot_longer(-subject,
               names_to = c('.value','model_type'),
               names_pattern = "(intercept|slope)_(flat|multilevel)")

beta_df_flat <- beta_df %>% filter(model_type == 'flat')
beta_df_ml <- beta_df %>% filter(model_type == 'multilevel')

# Shrinkage of coefficients viewed by the lines of best fit
p1 <- beta_df %>%
  ggplot() +
  geom_abline(aes(intercept = intercept, slope = slope, colour = model_type)) +
  facet_wrap(~subject) +
  scale_color_manual(values=c( "#E69F00", "#56B4E9")) +
  lims(x = c(0, 10),
       y = c(200, 500)) +
  theme_minimal()

# Shrinkage of coefficients superimposed on multivariate normal
p2 <- ggplot() +
  geom_path(data = contour_df,
            mapping = aes(x = x, y = y, group = level), size = 0.5, alpha = 0.5) +
  geom_segment(data = beta_df2,
               mapping = aes(x = intercept_flat, xend = intercept_multilevel, y = slope_flat, yend = slope_multilevel),
               arrow = arrow(length = unit(0.01, "npc"))
  ) +
  geom_text_repel(data = beta_df_flat,
                  mapping = aes(x = intercept, y = slope, label = subject), size = 3) +
  theme(legend.position = "bottom") + scale_shape_manual(values=c(1, 16)) +
  labs(x = TeX('$\\beta_0$'),
       y = TeX('$\\beta_1$'))

p2



## ---- echo=T---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
M_ml_vi <- lmer(Reaction ~ Days + (1|Subject),
                data = sleepstudy)


## ---- echo=T---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
fixef(M_ml_vi)


## ---- echo=T---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
VarCorr(M_ml_vi)


## ---- echo=T---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
M_ml_vs <- lmer(Reaction ~ Days + (0+Days|Subject),
                data = sleepstudy)


## ---- echo=T---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
fixef(M_ml_vs)


## ---- echo=T---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
VarCorr(M_ml_vs)


## ---- vivs, echo=F,fig.cap='Lines of best fit for each data group in a varying intercepts only a) or varying slopes only b) multilevel linear model.', fig.align="center", out.width="\\textwidth"-------------
plot_vi_vs <- function(M){
  M %>%
    coef() %>%
    extract2('Subject') %>%
    rename(intercept = `(Intercept)`, slope = Days) %>%
    rownames_to_column('subject') %>%
    ggplot() +
    geom_abline(aes(intercept = intercept, slope = slope, colour = subject)) +
    xlim(0, 10) +
    ylim(100, 500) +
    theme(legend.position = 'none')
}

p1 <- M_ml_vi %>% plot_vi_vs()
p2 <- M_ml_vs %>% plot_vi_vs()

plot_grid(p1, p2, labels=c('a', 'b'), hjust = -5)


## ---- echo=T---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
M_ml_diag <- lmer(Reaction ~ Days + (1|Subject) + (0+Days|Subject),
                  data = sleepstudy)


## ---- echo=T---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
M_ml_diag2 <- lmer(Reaction ~ Days + (Days||Subject),
                   data = sleepstudy)


## ---- echo=T---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
fixef(M_ml_diag2)


## ---- echo=T---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
VarCorr(M_ml_diag2)


## ---- echo=T---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
classroom_df <- read_csv(here('data/classroom.csv'))


## ----classroom, echo=F, fig.cap="The line of best fit for the children in the school is shown.", fig.align='center', out.width='\\textwidth'-------------------------------------------------------------------
x <- classroom_df %>% 
  filter(schoolid %in% c(31, 33, 71, 76, 77, 93)) 

y <- left_join(x,
               x %>% 
                 select(schoolid, classid) %>% 
                 distinct() %>% 
                 group_by(schoolid) %>%
                 mutate(k = row_number()) %>%
                 ungroup()
) %>% mutate(classid = as.factor(k))

p1 <- y %>% 
  ggplot(aes(x = ses, y = mathscore, colour = classid)) +
  geom_point(size = 0.5) +
  stat_smooth(size = 0.5, method = 'lm', se = F, fullrange = T) +
  facet_wrap(~schoolid) +
  theme_minimal() + 
  theme(legend.position = 'none')

p2 <- y %>% 
  ggplot(aes(x = ses, y = mathscore)) +
  geom_point(size = 0.5) +
  stat_smooth(size = 0.5, method = 'lm', se = F, fullrange = T) +
  facet_wrap(~schoolid) +
  theme_minimal() + 
  theme(legend.position = 'none')

p2





## ----classroom2, echo=F, fig.cap="A separate line of best fit for each class within each school is shown.", fig.align='center', out.width='\\textwidth'--------------------------------------------------------

p1





## ---- echo=T---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
M_classroom <- lmer(
  mathscore ~ ses + (ses|classid) + (ses|schoolid),
  data = classroom_df)


## ---- echo=T---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
VarCorr(M_classroom)


## ---- echo=T---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
M_classroom <- lmer(
  mathscore ~ ses + (ses||classid) + (ses|schoolid),
  data = classroom_df)


## ---- echo=T---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
fixef(M_classroom)


## ---- echo=T---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
VarCorr(M_classroom)


## ---- echo=T---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
classroom_df %>% 
  sample_n(3)


## ---- echo=T---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
M_classroom_vi <- lmer(
  mathscore ~ ses + (1|schoolid/classid2),
  data = classroom_df)


## ---- echo=T---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
M_classroom_vi2 <- lmer(
  mathscore ~ ses + (1|schoolid) + (1|schoolid:classid2),
  data = classroom_df)


## ---- echo=T---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
blp_df <- read_csv(here('data/blp-short2.csv'))


## ---- echo=T---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
M_blp <- lmer(rt ~ 1 + (1|participant) + (1|spelling),
              data = blp_df)


## ---- echo=T---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
fixef(M_blp)


## ---- echo=T---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
VarCorr(M_blp)


## ---- echo=T---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
mathachschool_df <- read_csv(here('data/mathachieveschool.csv'))
mathach_df <- read_csv(here('data/mathachieve.csv'))


## ---- echo=T---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
mathach_df2 <- left_join(mathach_df,
                         mathachschool_df, 
                         by = 'school')


## ---- eval=F, echo=T-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
## # does not work
## lmer(mathach ~ pracad + (pracad|school), data = mathach_df2)


## ---- echo=T---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# does work
# glp: group level predictor
M_glp <- lmer(mathach ~ pracad + (1|school), data = mathach_df2)


## ---- echo=T---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
fixef(M_glp)


## ---- echo=T---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
VarCorr(M_glp)


## ----himinty_plot,  fig.cap="How mathematical achievement varies by a child's socioeconomic background across a sample of different school. Schools are colour coded to indicate whether they have high ethnic minority proportions (lighter colour) or not.", echo=F----
set.seed(1045)
left_join(mathach_df,
          mathachschool_df, 
          by = 'school') %>% 
  filter(school %in% sample(unique(school), 20)) %>% 
  ggplot(aes(x = ses, y = mathach, colour = himinty)) + 
  geom_point(size = 0.5) +
  stat_smooth(method = 'lm', se = F) +
  facet_wrap(~school) +
  theme_minimal() +
  theme(legend.position = "none")


## ---- echo=T---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# glp: group level predictor
M_glp <- lmer(mathach ~ ses + himinty + ses:himinty + (ses|school),
                data = mathach_df2)


## ---- echo=T---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
  VarCorr(M_glp)


## ---- echo=T---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
  fixef(M_glp)


## ---- echo=T---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
sleepstudy2 <- sleepstudy %>%
  mutate(fast_rt = Reaction < median(Reaction))
  
M <- glmer(fast_rt ~ Days + (Days|Subject),
             family = binomial(link = 'logit'),
             data = sleepstudy2)
  


## ----echo = T, m_bayes, cache=T--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
M_bayes <- brm(Reaction ~ Days + (Days|Subject),
               data = sleepstudy)


## ---- eval=F---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
## M_bayes


## ---- echo=T---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
M_bayes$prior

